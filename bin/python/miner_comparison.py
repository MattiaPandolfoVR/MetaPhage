#!/usr/bin/env python3
# Coded by Mattia Pandolfo (mattia.pandolfo@univr.it)
software = "miner_comparison.py"
version = "0.0.1"

import os, sys
import re
import pandas as pnd
from Bio import SeqIO
from Bio.SeqRecord import SeqRecord

assembler = sys.argv[1]

# VIRAL CONTIGS
# create the file where to print the viral contigs data-frame
mvc_comp = open(assembler + "_mined_viral_contigs_comp.tsv", 'w')
# create a data-frame with pandas, initializing columns
mvc_df = pnd.DataFrame(data = {
    'ContigsID': [],
    'Length': [],
    'Deepvirfinder': [],
    'Phigaro': [],
    'Vibrant': [],
    'Virfinder': [],
    'Virsorter2': []
})
# open mined viral contigs fasta file (generated concatenating miner outputs)
vir_cont = open("concat_" + assembler + ".fasta", "r")
records = SeqIO.parse(vir_cont,'fasta')
for record in records:
    # initialize variables to populate the data-frame
    contigsID = ''
    length = 0
    flDeepvirfinder = False
    flPhigaro = False
    flVibrant = False
    flVirfinder = False
    flVirsorter2 = False
    # in the matrix ContigsID column, put the contig name
    contigsID = record.id.split('_',1)[1]
    # in Length, put the nucleotide length
    length = len(record.seq)
    # in miner, which tool extracted it
    miner = record.id.split('_')[0]
    # in prophage, we put the name of the prophage, for phigaro contigs only
    # look for the miner flag in the viral contigs name, and set the correspondant flag to true
    if miner == "deepvirfinder": flDeepvirfinder = True
    elif miner == "phigaro": flPhigaro = True
    elif miner == "vibrant": flVibrant = True
    elif miner == "virsorter2": flVirsorter2 = True
    elif miner == "virfinder": flVirfinder = True
    else: print("ERROR: strange miner here!")
    cont = mvc_df[mvc_df['ContigsID']==contigsID]
    # populate the data-frame 
    if len(cont) == 1:
        if flDeepvirfinder: mvc_df.loc[mvc_df['ContigsID'] == contigsID,['Deepvirfinder']] += 1
        elif flPhigaro: mvc_df.loc[mvc_df['ContigsID'] == contigsID,['Phigaro']] += 1
        elif flVibrant: mvc_df.loc[mvc_df['ContigsID'] == contigsID,['Vibrant']] += 1
        elif flVirfinder: mvc_df.loc[mvc_df['ContigsID'] == contigsID,['Virfinder']] += 1
        elif flVirsorter2: mvc_df.loc[mvc_df['ContigsID'] == contigsID,['Virsorter2']] += 1
    elif len(cont) == 0:
        mvc_df = mvc_df.append({
            'ContigsID': contigsID,
            'Length': length,
            'Deepvirfinder': 1 if flDeepvirfinder else 0,
            'Phigaro': 1 if flPhigaro else 0,
            'Vibrant': 1 if flVibrant else 0,
            'Virfinder': 1 if flVirfinder else 0,
            'Virsorter2': 1 if flVirsorter2 else 0
        }, ignore_index=True)
    else: print("ERROR: impossible length!")
# change the type of miners and length cells from float to int (better visualization)
mvc_df['Deepvirfinder'] = mvc_df['Deepvirfinder'].astype(int)
mvc_df['Phigaro'] = mvc_df['Phigaro'].astype(int)
mvc_df['Vibrant'] = mvc_df['Vibrant'].astype(int)
mvc_df['Virfinder'] = mvc_df['Virfinder'].astype(int)
mvc_df['Virsorter2'] = mvc_df['Virsorter2'].astype(int)
mvc_df['Length'] = mvc_df['Length'].astype(int)
mvc_comp.write(mvc_df.to_string())
mvc_comp.close()

# vOTUs
# open dereplicated clustered file (generated by CD-HIT-EST)
clstr = open("derep95_" + assembler + ".fasta.clstr", "r")
whole = clstr.read()
clstr.close()
# create the file where to print the data-frame
miner_comp = open(assembler + "_min_comp.tsv", 'w')
# create a data-frame with pandas, initializing columns
df = pnd.DataFrame(data = {
    'Cluster': [],
    'Header': [],
    'ViralOTU': [],
    'Length': [],
    'Deepvirfinder': [],
    'Phigaro': [],
    'Vibrant': [],
    'Virfinder': [],
    'Virsorter2': []
})
# add a counter for the loop
counter = 1
# for each Cluster in .clstr 
for cluster in whole.split(">Cluster"):
    if counter == 1:
        counter += 1
        continue
    # split each rows by its newline character
    cluster_rows = cluster.split('\n')
    
    # initialize variables to populate the data-frame
    header = ''
    length = 0
    flDeepvirfinder = False
    flPhigaro = False
    flVibrant = False
    flVirfinder = False
    flVirsorter2 = False
    # remove the last element of a row if its a ''
    if cluster_rows[-1] == '': cluster_rows.pop(-1)
    # loop from the second element [index 1]
    for row in cluster_rows[1:]:
        # if the rows ends with * its the one in which CD-HIT collapse the other
        if row.endswith('*'):
            # in header, put the header of the sequence
            header = row.replace('... *', '').split('>')[1]
            # in length, put the nucleotide length
            length = row.split('\t')[1].split('>')[0].replace('nt, ','')
        miner = row.split('>')[1].split('_')[0]
        # look for the miner flag in the sequence collapsed in this cluster, and set the correspondant flag to true
        if miner == "deepvirfinder": flDeepvirfinder = True
        elif miner == "phigaro": flPhigaro = True
        elif miner == "vibrant": flVibrant = True
        elif miner == "virsorter2": flVirsorter2 = True
        elif miner == "virfinder": flVirfinder = True
        else: print("ERROR: strange miner here!")
    # populate the data-frame
    df = df.append({
        'Cluster': 'Cluster_' + cluster_rows[0].replace(' ', ''),
        'Header': header,
        'ViralOTU': "vOTU_" + str(counter -1),
        'Length': length,
        'Deepvirfinder': 1 if flDeepvirfinder else 0,
        'Phigaro': 1 if flPhigaro else 0,
        'Vibrant': 1 if flVibrant else 0,
        'Virfinder': 1 if flVirfinder else 0,
        'Virsorter2': 1 if flVirsorter2 else 0
    }, ignore_index=True)
    counter += 1
# change the type of miners and length cells from float to int (better visualization)
df['Deepvirfinder'] = df['Deepvirfinder'].astype(int)
df['Phigaro'] = df['Phigaro'].astype(int)
df['Vibrant'] = df['Vibrant'].astype(int)
df['Virfinder'] = df['Virfinder'].astype(int)
df['Virsorter2'] = df['Virsorter2'].astype(int)
df['Length'] = df['Length'].astype(int)
# remove those cells in which nt length is less than 1000 (Evelien advice)
df_higher = df[(df['Length'] >= 1000)]
#print(df_higher.to_string())
miner_comp.write(df_higher.to_string())
miner_comp.close()

# rename the fasta sequences headers with vOTU names
# open the filtered sequences file
renamed = []
for seqrec in SeqIO.parse("filtered_derep95_" + assembler + ".fasta", 'fasta'):
    # match the sequence header with df[header] and set newid as the corresponding vOTU name
    newid = list(df[df["Header"] == seqrec.id]["ViralOTU"])
    newid = ''.join(newid)
    # append to sequence and write to file
    renamed.append(SeqRecord(seqrec.seq, id=newid, description=''))
SeqIO.write(renamed, "vOTU_" + assembler + ".fasta", 'fasta')
